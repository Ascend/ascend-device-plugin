component: ascend-device-plugin
systemEnv:
  - workspace
  - processor
compile:
  input:
    envVariables:
      GO111MODULE: "on"
      GONOSUMDB: "*"
      CGO_ENABLED: "1"
      CGO_CFLAGS: "-fstack-protector-strong -D_FORTIFY_SOURCE=2 -O2 -fPIC -ftrapv"
      CGO_CPPFLAGS: "-fstack-protector-strong -D_FORTIFY_SOURCE=2 -O2 -fPIC -ftrapv"
    files:
      exclude:
        - remove: ["{{ systemEnv.workspace }}/{{ component}}/output/"]
  process:
    language: go
    compilePath: "{{ systemEnv.workspace }}/ascend-device-plugin/"
    parameters: [['buildmode', "pie"],
                 ["mod", "mod"],
                 ['ldflags', '-X "main.BuildName=device-plugin" -X "main.BuildVersion={{version}}_linux-{{systemEnv.processor}}" -buildid none -s -extldflags=-Wl,-z,relro,-z,now,-z,noexecstack'],
                 ["o", "device-plugin"],
                 ['trimpath',""],]
  output:
    files:
      include:
        - move:
            src: ["{{ systemEnv.workspace }}/ascend-device-plugin/device-plugin"]
            des: "{{ systemEnv.workspace }}/{{component}}/output"
        - mode:
            src:
              - "{{ systemEnv.workspace }}/{{ component}}/output/*"
            mode: 400
        - mode:
            src:
              - "{{ systemEnv.workspace }}/{{ component}}/output/device-plugin"
            mode: 500
        - commands:
            - command: "if [ -d '{{systemEnv.workspace }}/npu-exporter' ];
        then cp -rf {{ systemEnv.workspace }}/npu-exporter/lib {{ systemEnv.workspace }}/ascend-device-plugin/output;
        cp -rf {{ systemEnv.workspace }}/npu-exporter/cert-importer {{ systemEnv.workspace }}/ascend-device-plugin/output;
        chmod 550 {{ systemEnv.workspace }}/ascend-device-plugin/output/lib;
        chmod 500 {{ systemEnv.workspace }}/ascend-device-plugin/output/lib/*;
        chmod 500 {{ systemEnv.workspace }}/ascend-device-plugin/output/cert-importer;fi"
        - makeArchive:
            - src: "{{ systemEnv.workspace }}/{{ component}}/output/"
              des: "{{ systemEnv.workspace }}/{{ component}}/output/Ascend-mindxdl-device-plugin_{{pkgversion}}_linux-{{ systemEnv.processor }}"
              prefix: zip
              arch: "{{ systemEnv.processor }}"

test:
  input:
    files:
  process:
    type: ut
    testTool: shell
    execdir: "{{systemEnv.workspace}}/{{component}}/build"
    parameters: ""
    script: "test.sh"
  output: